{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}
    {% if form.instance.pk %}{% trans "Edit Journal Entry" %}{% else %}{% trans "Write New Journal Entry" %}{% endif %}
{% endblock %}

{% block extra_head %}
<style>
    /* Force consistent focus styles for text inputs, textareas, and selects */
    input[type="text"]:focus,
    textarea:focus,
    select:focus {
        outline: none !important;
        box-shadow: 0 0 0 0.2rem rgba(96, 165, 250, 0.25) !important; /* Tailwind blue-400 equivalent */
        border-color: #60a5fa !important; /* Tailwind blue-400 */
    }

    .dark input[type="text"]:focus,
    .dark textarea:focus,
    .dark select:focus {
        box-shadow: 0 0 0 0.2rem rgba(147, 197, 253, 0.25) !important; /* Tailwind blue-300 equivalent */
        border-color: #93c5fd !important; /* Tailwind blue-300 */
    }

    /* Custom styling for the file input button using Tailwind-like classes */
    .custom-file-input::file-selector-button {
        margin-right: 1rem; /* file:mr-4 */
        padding-top: 0.5rem; /* file:py-2 */
        padding-bottom: 0.5rem; /* file:py-2 */
        padding-left: 1rem; /* file:px-4 */
        padding-right: 1rem; /* file:px-4 */
        border-radius: 0.375rem; /* file:rounded-md */
        border-width: 0; /* file:border-0 */
        font-size: 0.875rem; /* file:text-sm */
        font-weight: 600; /* file:font-semibold */
        background-color: #3b82f6; /* file:bg-primary-light (example blue-500) */
        color: #ffffff; /* file:text-white */
        cursor: pointer;
        transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
    }

    .custom-file-input:hover::file-selector-button {
        background-color: #2563eb; /* hover:file:bg-primary-dark (example blue-600) */
    }

    .dark .custom-file-input::file-selector-button {
        background-color: #60a5fa; /* Dark mode primary-light (example blue-400) */
    }

    .dark .custom-file-input:hover::file-selector-button {
        background-color: #3b82f6; /* Dark mode hover:primary-dark (example blue-500) */
    }
</style>
{% endblock %}


{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-card-light dark:bg-card-dark p-6 sm:p-8 rounded-xl shadow-custom-light dark:shadow-custom-dark w-full max-w-3xl mx-auto">
        <h1 class="text-3xl font-bold text-text-light dark:text-text-dark mb-6 text-center">
            {% if form.instance.pk %}{% trans "Edit Journal Entry" %}{% else %}{% trans "Write New Journal Entry" %}{% endif %}
        </h1>

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            {# Display non-field errors for the main form #}
            {% if form.non_field_errors %}
                <div class="mb-4 p-3 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 rounded-md">
                    {% for error in form.non_field_errors %}
                        <p class="text-sm text-red-700 dark:text-red-300">{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            {# Loop through standard form fields #}
            {% for field in form %}
                {% if field.name != 'shared_details' and field.name != 'is_favorite' %}
                    <div class="mb-4">
                        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                            {{ field.label }} {% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                        </label>
                        {% if "Textarea" in field.field.widget|stringformat:"s" %}
                            <textarea name="{{ field.name }}"
                                      id="{{ field.id_for_label }}"
                                      class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:placeholder-gray-400 sm:text-sm transition duration-150 ease-in-out"
                                      {% if field.field.required %}required{% endif %}
                                      rows="{{ field.field.widget.attrs.rows|default:8 }}"
                                      placeholder="{{ field.field.widget.attrs.placeholder|default:'' }}"
                                      >{{ field.value|default:'' }}</textarea>
                        {% elif "Select" in field.field.widget|stringformat:"s" %}
                            <select name="{{ field.name }}"
                                    id="{{ field.id_for_label }}"
                                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-primary-light focus:ring-0 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:focus:border-primary-dark sm:text-sm appearance-none transition duration-150 ease-in-out"
                                    {% if field.field.required %}required{% endif %}>
                                {% for value, text in field.field.choices %}
                                    <option value="{{ value }}" {% if field.value|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>{{ text }}</option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <input type="{{ field.field.widget.input_type|default:'text' }}"
                                   name="{{ field.name }}"
                                   id="{{ field.id_for_label }}"
                                   value="{{ field.value|default:'' }}"
                                   class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:placeholder-gray-400 sm:text-sm transition duration-150 ease-in-out"
                                   {% if field.field.required %}required{% endif %}
                                   {% if field.field.max_length %}maxlength="{{ field.field.max_length }}"{% endif %}
                                   placeholder="{{ field.field.widget.attrs.placeholder|default:'' }}"
                                   {% for attr, val in field.field.widget.attrs.items %}
                                       {% if attr != 'class' and attr != 'id' and attr != 'name' and attr != 'type' and attr != 'value' and attr != 'required' and attr != 'maxlength' and attr != 'placeholder' and attr != 'rows' %}
                                           {{ attr }}="{{ val }}"
                                       {% endif %}
                                   {% endfor %}>
                        {% endif %}
                        {% if field.help_text %}
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ field.help_text|safe }}</p>
                        {% endif %}
                        {% for error in field.errors %}
                            <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endfor %}


            {# --- Attachment Formset --- #}
            <div class="mb-6 border-t border-border-light dark:border-border-dark pt-6 mt-6">
                <h3 class="text-xl font-semibold text-text-light dark:text-text-dark mb-4">{% trans "Attachments" %}:</h3>

                {{ attachment_formset.management_form }}

                {% if attachment_formset.non_form_errors %}
                    <div class="mb-4 p-3 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 rounded-md">
                        {% for error in attachment_formset.non_form_errors %}
                            <p class="text-sm text-red-700 dark:text-red-300">{% trans "Attachment Error" %}: {{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <div id="attachments-container" class="space-y-6">
                    {% for formset_form in attachment_formset %}
                        <div class="attachment-item p-4 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm 
                                    {% if formset_form.instance.pk and formset_form.instance.file %}bg-gray-50 dark:bg-gray-800{% else %}bg-white dark:bg-gray-700{% endif %}">
                            {# ^-- Updated dark mode backgrounds here --^ #}
                            
                            {{ formset_form.id }} {# Hidden ID field for existing forms, crucial for formset #}

                            {% if formset_form.instance and formset_form.instance.pk and formset_form.instance.file %}
                                {# --- Displaying an EXISTING attachment --- #}
                                <div class="existing-attachment-info mb-3">
                                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        {% trans "Current file" %}:
                                    </p>
                                    <div class="flex items-center space-x-3">
                                        <svg class="h-6 w-6 text-gray-500 dark:text-gray-400 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                                        </svg>
                                        <a href="{{ formset_form.instance.file.url }}" target="_blank"
                                           class="text-primary-light dark:text-primary-dark hover:underline break-all">
                                            {{ formset_form.instance.file.name|slice:"20:"|default:formset_form.instance.file.name }}
                                        </a>
                                    </div>

                                    {% with file_url=formset_form.instance.file.url|lower %}
                                        {% if ".jpg" in file_url or ".jpeg" in file_url or ".png" in file_url or ".gif" in file_url or ".webp" in file_url %}
                                            <img src="{{ formset_form.instance.file.url }}" alt="{% trans 'Preview' %}"
                                                 class="mt-2 max-w-full sm:max-w-xs max-h-32 rounded-md border dark:border-gray-500 object-contain bg-gray-100 dark:bg-gray-600 p-1">
                                                 {# ^-- Updated dark mode background for image preview --^ #}
                                        {% endif %}
                                    {% endwith %}
                                </div>

                                <div class="mb-3">
                                    <label for="{{ formset_form.file.id_for_label }}" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                        {% trans "Change file (optional)" %}:
                                    </label>
                                    {{ formset_form.file }} {# File input for changing the existing file #}
                                    {% for error in formset_form.file.errors %}
                                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                    {% endfor %}
                                </div>

                                {% if attachment_formset.can_delete and formset_form.instance.pk %}
                                <div class="flex items-center mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                                    {{ formset_form.DELETE }}
                                    <label for="{{ formset_form.DELETE.id_for_label }}" class="ml-2 text-sm font-medium text-red-600 dark:text-red-400 hover:text-red-700 dark:hover:text-red-500 cursor-pointer">
                                        {% trans "Mark for deletion" %}
                                    </label>
                                </div>
                                {% endif %}

                            {% else %}
                                {# --- Displaying a form for a NEW attachment --- #}
                                <div class="mb-2">
                                    <label for="{{ formset_form.file.id_for_label }}" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">
                                        {% trans "Add new attachment" %}:
                                    </label>
                                    {{ formset_form.file }} {# File input for new file #}
                                    {% for error in formset_form.file.errors %}
                                        <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% for error in formset_form.non_field_errors %}
                                <p class="mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
            {# --- End Attachment Formset --- #}


            {% with is_favorite_field=form.is_favorite %}
                <div class="mb-6 mt-6 pt-6 border-t border-border-light dark:border-border-dark flex items-center">
                    <input type="checkbox"
                           name="{{ is_favorite_field.name }}"
                           id="{{ is_favorite_field.id_for_label }}"
                           class="h-4 w-4 text-primary-light border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-primary-dark dark:checked:border-primary-dark focus:ring-primary-light dark:focus:ring-primary-dark"
                           {% if is_favorite_field.value %}checked{% endif %}>
                    <label for="{{ is_favorite_field.id_for_label }}" class="ml-2 block text-sm font-medium text-text-light dark:text-text-dark">
                        {{ is_favorite_field.label }}
                    </label>
                    {% if is_favorite_field.help_text %}
                        <p class="ml-2 mt-1 text-xs text-gray-500 dark:text-gray-400">{{ is_favorite_field.help_text|safe }}</p>
                    {% endif %}
                    {% for error in is_favorite_field.errors %}
                        <p class="ml-2 mt-1 text-sm text-red-600 dark:text-red-400">{{ error }}</p>
                    {% endfor %}
                </div>
            {% endwith %}

            <button type="submit" class="w-full px-6 py-3 bg-primary-light text-white rounded-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark dark:focus:ring-offset-gray-800 transition duration-150 ease-in-out font-semibold mt-6 shadow-md">
                {% if form.instance.pk %}{% trans "Save Changes" %}{% else %}{% trans "Save Entry" %}{% endif %}
            </button>
        </form>

        <div class="mt-6 text-center">
            {% if form.instance.pk %}
                <a href="{% url 'journal:journal_detail' pk=form.instance.pk %}" class="text-sm text-primary-light dark:text-primary-dark hover:underline">{% trans "Cancel" %}</a>
            {% else %}
                <a href="{% url 'journal:journal_list' %}" class="text-sm text-primary-light dark:text-primary-dark hover:underline">{% trans "Cancel" %}</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
