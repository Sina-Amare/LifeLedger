{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "AI Insights Dashboard" %} - {{ block.super }}{% endblock %}

{% block extra_head %}
    <style>
        /* Custom styles for better chart appearance and filter buttons */
        .chart-card, .insights-card {
            background-color: white;
            border-radius: 1rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); /* shadow-lg */
            transition: background-color 0.3s ease;
        }
        .dark .chart-card, .dark .insights-card {
            background-color: #1f2937; /* Tailwind gray-800 */
        }

        .chart-container {
            position: relative;
            height: 60vh;
            max-height: 500px;
            width: 100%;
        }

        .time-filter-buttons button {
            transition: all 0.2s ease-in-out;
            border: 1px solid transparent;
        }
        
        .time-filter-buttons button.active {
            background-color: #3B82F6; /* Tailwind blue-600 */
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .dark .time-filter-buttons button.active {
            background-color: #60A5FA; /* Tailwind blue-400 */
            color: #1f2937;
        }

        .chart-loader, .insights-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .insights-result-list li {
            position: relative;
            padding-left: 1.75rem; /* Space for the icon */
            margin-bottom: 0.75rem;
            transition: color 0.2s ease;
        }
        .insights-result-list li:hover {
            color: #3B82F6; /* Highlight on hover */
        }
        .dark .insights-result-list li:hover {
            color: #60A5FA;
        }
        .insights-result-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0.25rem; /* Adjust vertical alignment */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 0.8em; /* Slightly smaller icon */
            text-align: center;
            line-height: 1.25rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background-color: currentColor;
            color: white;
        }
        .highlights-list li::before { content: '\f005'; background-color: #f59e0b; } /* Star */
        .challenges-list li::before { content: '\f071'; background-color: #ef4444; } /* Warning */
        .themes-list li::before { content: '\f02b'; background-color: #8b5cf6; } /* Bookmark/Tag */

    </style>
{% endblock %}

{% block content %}
<section class="py-12 md:py-16 bg-gray-50 dark:bg-gray-900 min-h-full">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <header class="text-center mb-10 md:mb-12">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white mb-3 tracking-tight">
                <i class="fas fa-brain text-blue-500 dark:text-blue-400 mr-3"></i>{% trans "AI Insights Dashboard" %}
            </h1>
            <p class="text-md text-gray-600 dark:text-gray-400 max-w-xl mx-auto">
                {% trans "Discover patterns and insights from your journal entries over time." %}
            </p>
        </header>

        <div class="chart-card">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-900 dark:text-white">
                    {% trans "Sentiment Analysis" %}
                </h2>
                <div class="flex flex-wrap justify-center gap-2 sm:gap-3 time-filter-buttons" role="group" aria-label="{% trans 'Time period filter' %}">
                    {% for option in time_period_options %}
                    <button 
                        type="button" 
                        class="px-4 py-2 text-xs sm:text-sm font-medium rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-800
                               bg-white text-gray-700 hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 border border-gray-300 dark:border-gray-600"
                        data-period="{{ option.value }}"
                        data-label="{{ option.label }}">
                        {{ option.label }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            <div class="chart-container">
                <div id="chartLoader" class="chart-loader hidden">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-500 dark:text-blue-400"></i>
                </div>
                <canvas id="sentimentTrendChart"></canvas>
                <div id="noChartDataMessage" class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 text-gray-600 dark:text-gray-300 hidden">
                    <i class="fas fa-info-circle text-5xl text-gray-400 dark:text-gray-500 mb-4"></i>
                    <p class="font-semibold">{% trans "Not enough data to display sentiment trends." %}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                        {% trans "Try selecting a different time period or write more journal entries." %}
                    </p>
                </div>
            </div>
        </div>

        {# NEW: Collective Insights Section #}
        <div class="mt-16">
            <header class="text-center mb-10">
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight">{% trans "Deeper Analysis" %}</h2>
                <p class="mt-2 text-md text-gray-600 dark:text-gray-400">{% trans "Generate a summary of highlights, challenges, and key themes from the selected period." %}</p>
            </header>
            <div class="insights-card relative">
                <div id="insights-container" class="min-h-[200px] flex flex-col items-center justify-center transition-all duration-300">
                    <div id="insights-initial-prompt" class="text-center">
                        <p class="text-gray-500 dark:text-gray-400 mb-4">{% trans "Ready to uncover deeper insights?" %}</p>
                        <button id="generate-insights-btn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2 transform hover:scale-105">
                            <i class="fas fa-lightbulb"></i>
                            <span>{% trans "Generate Key Insights" %}</span>
                        </button>
                    </div>
                    <div id="insights-loader" class="text-center hidden">
                        <i class="fas fa-cog fa-spin text-4xl text-blue-500 dark:text-blue-400"></i>
                        <p class="mt-4 text-gray-600 dark:text-gray-300">{% trans "Analyzing your entries... This may take a moment." %}</p>
                    </div>
                    <div id="insights-results" class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full hidden">
                        <div class="insights-column">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4 border-b-2 border-yellow-400 pb-2 flex items-center gap-2">
                                <i class="fas fa-star text-yellow-400"></i> {% trans "Highlights" %}
                            </h4>
                            <ul id="highlights-list" class="space-y-3 text-gray-600 dark:text-gray-300 text-sm insights-result-list highlights-list"></ul>
                        </div>
                        <div class="insights-column">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4 border-b-2 border-red-400 pb-2 flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle text-red-400"></i> {% trans "Challenges" %}
                            </h4>
                            <ul id="challenges-list" class="space-y-3 text-gray-600 dark:text-gray-300 text-sm insights-result-list challenges-list"></ul>
                        </div>
                        <div class="insights-column">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4 border-b-2 border-purple-400 pb-2 flex items-center gap-2">
                                <i class="fas fa-bookmark text-purple-400"></i> {% trans "Key Themes" %}
                            </h4>
                            <ul id="themes-list" class="space-y-3 text-gray-600 dark:text-gray-300 text-sm insights-result-list themes-list"></ul>
                        </div>
                    </div>
                     <div id="insights-error" class="text-center text-red-500 hidden font-medium"></div>
                </div>
            </div>
        </div>

    </div>
</section>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Chart Logic (from previous step) ---
            const chartCanvas = document.getElementById('sentimentTrendChart');
            const chartLoader = document.getElementById('chartLoader');
            const noDataMessageElement = document.getElementById('noChartDataMessage');
            const timeFilterButtons = document.querySelectorAll('.time-filter-buttons button');
            
            let sentimentChart = null;
            let activeTimePeriod = '{{ selected_period|escapejs }}' || 'last_30_days';

            function getChartColors() {
                const isDark = document.documentElement.classList.contains('dark');
                return {
                    ticks: isDark ? '#e5e7eb' : '#4b5563', title: isDark ? '#9ca3af' : '#6b7280',
                    grid: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                    tooltip: { bg: isDark ? '#374151' : '#fff', title: isDark ? '#f3f4f6' : '#1f2937', body: isDark ? '#d1d5db' : '#4b5563', border: isDark ? '#4b5563' : '#e5e7eb' }
                };
            }

            function renderChart(chartData) {
                const colors = getChartColors();
                const chartConfig = {
                    type: 'bar', data: chartData,
                    options: {
                        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                        scales: {
                            y: { beginAtZero: true, ticks: { color: colors.ticks, font: { family: 'Inter, sans-serif' } }, grid: { color: 'transparent', borderColor: 'transparent' } },
                            x: { beginAtZero: true, title: { display: true, text: `{% trans "Number of Entries" %}`, color: colors.title, font: { family: 'Inter, sans-serif', weight: '500' } }, ticks: { color: colors.ticks, font: { family: 'Inter, sans-serif' }, precision: 0 }, grid: { color: colors.grid, borderColor: colors.grid } }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: { backgroundColor: colors.tooltip.bg, titleColor: colors.tooltip.title, bodyColor: colors.tooltip.body, borderColor: colors.tooltip.border, borderWidth: 1, padding: 12, cornerRadius: 8, displayColors: false, callbacks: { label: (context) => `{% trans "Entries" %}: ${context.parsed.x}` } }
                        },
                        onHover: (event, chartElement) => { event.native.target.style.cursor = chartElement.length ? 'pointer' : 'default'; },
                    }
                };
                if (sentimentChart) { sentimentChart.data = chartData; Object.assign(sentimentChart.options, chartConfig.options); sentimentChart.update(); } 
                else if (chartCanvas) { sentimentChart = new Chart(chartCanvas, chartConfig); }
            }

            async function fetchAndUpdateChart(timePeriod, buttonElement) {
                if (chartLoader) chartLoader.classList.remove('hidden');
                if (chartCanvas) chartCanvas.style.visibility = 'hidden';
                if (noDataMessageElement) noDataMessageElement.classList.add('hidden');

                timeFilterButtons.forEach(btn => btn.classList.remove('active'));
                if(buttonElement) buttonElement.classList.add('active');

                activeTimePeriod = timePeriod;

                try {
                    const response = await fetch(`{% url 'journal:sentiment_chart_data_ajax' %}?time_period=${timePeriod}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const chartAPIData = await response.json();
                    if (chartAPIData && chartAPIData.has_data) {
                        renderChart(chartAPIData);
                    } else {
                        if (sentimentChart) { sentimentChart.destroy(); sentimentChart = null; }
                        if (noDataMessageElement) noDataMessageElement.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error fetching chart data:", error);
                    if (noDataMessageElement) { noDataMessageElement.innerHTML = `<p class="text-center text-red-500">{% trans "Error loading chart data." %}</p>`; noDataMessageElement.classList.remove('hidden'); }
                } finally {
                    if (chartLoader) chartLoader.classList.add('hidden');
                    if (chartCanvas) chartCanvas.style.visibility = 'visible';
                }
            }

            timeFilterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const period = this.dataset.period;
                    const url = new URL(window.location);
                    url.searchParams.set('time_period', period);
                    window.history.pushState({}, '', url);
                    fetchAndUpdateChart(period, this);
                });
            });

            // --- NEW: Insights Logic ---
            const generateBtn = document.getElementById('generate-insights-btn');
            const insightsInitialPrompt = document.getElementById('insights-initial-prompt');
            const insightsLoader = document.getElementById('insights-loader');
            const insightsResults = document.getElementById('insights-results');
            const insightsError = document.getElementById('insights-error');
            const highlightsList = document.getElementById('highlights-list');
            const challengesList = document.getElementById('challenges-list');
            const themesList = document.getElementById('themes-list');
            const csrfToken = '{{ csrf_token }}';
            let pollingInterval;

            function displayInsights(insights) {
                highlightsList.innerHTML = '';
                challengesList.innerHTML = '';
                themesList.innerHTML = '';

                if (insights.highlights && insights.highlights.length > 0) {
                    insights.highlights.forEach(item => { highlightsList.innerHTML += `<li>${item}</li>`; });
                } else {
                    highlightsList.innerHTML = `<li class="text-gray-400 italic">{% trans "No specific highlights found." %}</li>`;
                }

                if (insights.challenges && insights.challenges.length > 0) {
                    insights.challenges.forEach(item => { challengesList.innerHTML += `<li>${item}</li>`; });
                } else {
                    challengesList.innerHTML = `<li class="text-gray-400 italic">{% trans "No specific challenges found." %}</li>`;
                }

                if (insights.key_themes && insights.key_themes.length > 0) {
                    insights.key_themes.forEach(item => { themesList.innerHTML += `<li>${item}</li>`; });
                } else {
                    themesList.innerHTML = `<li class="text-gray-400 italic">{% trans "No recurring themes identified." %}</li>`;
                }
                
                insightsResults.classList.remove('hidden');
            }

            function pollForResult(taskId) {
                pollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch(`{% url 'journal:get_insights_result' %}?task_id=${taskId}`);
                        if (!response.ok) throw new Error('Polling request failed.');
                        const data = await response.json();

                        if (data.status === 'SUCCESS') {
                            clearInterval(pollingInterval);
                            insightsLoader.classList.add('hidden');
                            displayInsights(data.insights);
                        } else if (data.status === 'FAILURE') {
                            clearInterval(pollingInterval);
                            insightsLoader.classList.add('hidden');
                            insightsError.textContent = data.message || '{% trans "An error occurred during analysis." %}';
                            insightsError.classList.remove('hidden');
                        } // If PENDING or STARTED, do nothing and wait for the next poll
                    } catch (error) {
                        clearInterval(pollingInterval);
                        insightsLoader.classList.add('hidden');
                        insightsError.textContent = '{% trans "Could not retrieve analysis results." %}';
                        insightsError.classList.remove('hidden');
                        console.error('Polling error:', error);
                    }
                }, 3000); // Poll every 3 seconds
            }

            generateBtn.addEventListener('click', async () => {
                insightsInitialPrompt.classList.add('hidden');
                insightsResults.classList.add('hidden');
                insightsError.classList.add('hidden');
                insightsLoader.classList.remove('hidden');

                const formData = new FormData();
                formData.append('time_period', activeTimePeriod);
                
                try {
                    const response = await fetch(`{% url 'journal:start_insights_analysis' %}`, {
                        method: 'POST',
                        body: formData,
                        headers: { 'X-CSRFToken': csrfToken }
                    });

                    if (!response.ok) throw new Error('Failed to start analysis task.');
                    
                    const data = await response.json();
                    
                    if (data.status === 'processing' && data.task_id) {
                        pollForResult(data.task_id);
                    } else {
                        throw new Error(data.message || 'Unknown error starting task.');
                    }
                } catch (error) {
                    insightsLoader.classList.add('hidden');
                    insightsError.textContent = error.message;
                    insightsError.classList.remove('hidden');
                    console.error('Error starting analysis:', error);
                }
            });

            // --- Initial Load ---
            const initialActiveButton = document.querySelector(`.time-filter-buttons button[data-period="${activeTimePeriod}"]`);
            if (initialActiveButton) {
                fetchAndUpdateChart(activeTimePeriod, initialActiveButton);
            }

            // Theme change handler
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('themeChanged', () => {
                    if (sentimentChart) { renderChart(sentimentChart.data); }
                });
            }
        });
    </script>
{% endblock %}
