{% extends 'base.html' %}
{% load static %} {# Load the static files tag library #}
{% load i18n %} {# Load i18n for potential translation issues #}


{% block title %}{% trans "My Journal" %}{% endblock %} {# Added trans tag #}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-text-light dark:text-text-dark mb-8">{% trans "My Journal Entries" %}</h1> {# Added trans tag #}

    {# Link to create a new journal entry #}
    <div class="mb-6 text-right">
        <a href="{% url 'journal:journal_create' %}" class="inline-block px-6 py-3 bg-primary-light text-white rounded-md hover:bg-primary-dark transition duration-300 font-semibold shadow-md">
            + {% trans "Write New Entry" %} {# Added trans tag #}
        </a>
    </div>

    {# Filter and Search Form #}
    <form method="get" class="mb-8 p-6 bg-card-light dark:bg-card-dark rounded-xl shadow-custom-light dark:shadow-custom-dark grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
        {# Mood Filter #}
        <div>
            <label for="mood" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">{% trans "Filter by Mood" %}:</label> {# Added trans tag #}
            <select id="mood" name="mood" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-primary-light focus:ring-0 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:focus:border-primary-dark sm:text-sm appearance-none transition duration-200 ease-in-out">
                {# Assuming mood_options is available in context from views #}
                {% for value, label in mood_options %}
                    <option value="{{ value }}" {% if current_mood == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        {# Time Period Filter #}
        <div>
            <label for="time_period" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">{% trans "Filter by Time" %}:</label> {# Added trans tag #}
            <select id="time_period" name="time_period" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:border-primary-light focus:ring-0 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:focus:border-primary-dark sm:text-sm appearance-none transition duration-200 ease-in-out">
                 {# Assuming time_period_options is available in context from views #}
                {% for value, label in time_period_options %}
                    <option value="{{ value }}" {% if current_time_period == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        {# Favorite Filter #}
        <div class="flex items-center">
            <input id="is_favorite" name="is_favorite" type="checkbox" class="h-4 w-4 text-primary-light border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600 dark:checked:bg-primary-dark dark:checked:border-primary-dark focus:ring-primary-light dark:focus:ring-primary-dark" {% if current_is_favorite %}checked{% endif %}>
            <label for="is_favorite" class="ml-2 block text-sm font-medium text-text-light dark:text-text-dark">{% trans "Show Favorites Only" %}</label> {# Added trans tag #}
        </div>

        {# Search Input #}
        <div>
            <label for="q" class="block text-sm font-medium text-text-light dark:text-text-dark mb-1">{% trans "Search" %}:</label> {# Added trans tag #}
            <input type="text" id="q" name="q" value="{{ current_search_query }}" placeholder="{% trans "Search title or content..." %}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-500 focus:outline-none focus:border-primary-light focus:ring-0 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:placeholder-gray-400 dark:focus:border-primary-dark sm:text-sm transition duration-200 ease-in-out"> {# Added trans tag for placeholder #}
        </div>

        {# Submit Button #}
        <div class="md:col-span-2 lg:col-span-4 flex justify-end"> {# Span columns on larger screens and align right #}
             <button type="submit" class="px-6 py-2 bg-secondary-light text-white rounded-md hover:bg-secondary-dark transition duration-300 font-semibold shadow-md">
                 {% trans "Apply Filters & Search" %} {# Added trans tag #}
             </button>
             {# Optional: Add a button to clear filters #}
             {% if current_mood != 'all' or current_time_period != 'all' or current_is_favorite or current_search_query %}
                 <a href="{% url 'journal:journal_list' %}" class="ml-4 px-6 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-300 font-semibold shadow-md">
                     {% trans "Clear Filters" %} {# Added trans tag #}
                 </a>
             {% endif %}
        </div>
    </form>


    {# Check if there are any journal entries #}
    {% if entries %} {# Corrected variable name to entries #}
        <div id="journal-entries-list" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {# Loop through each journal entry #}
            {% for entry in entries %} {# Corrected variable name to entries #}
                {# Add a data attribute to easily identify the entry element #}
                <div id="entry-{{ entry.pk }}" class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-custom-light dark:shadow-custom-dark flex flex-col">
                    {# Link to the detail view of the entry #}
                    <a href="{% url 'journal:journal_detail' pk=entry.pk %}" class="block hover:underline">
                        <h2 class="text-2xl font-semibold text-primary-light dark:text-primary-dark mb-2 truncate">{{ entry.title|default:"Untitled Entry" }}</h2>
                    </a>
                    {# Display a snippet of the content #}
                    <p class="text-text-light dark:text-text-dark text-sm mb-4 flex-grow">{{ entry.content|truncatechars:200 }}</p>

                    {# Metadata: Date, Mood, Location (if available) #}
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-auto">
                         <p class="mb-1">
                              <i class="far fa-calendar-alt mr-1"></i>
                              {# Wrap date/time text in span for consistent font #}
                              <span>{{ entry.created_at|date:"F j, Y" }} at {{ entry.created_at|date:"P" }}</span>
                         </p>
                         {% if entry.mood %}
                              <p class="mb-1">
                                   <i class="far fa-smile mr-1"></i>
                                   {# Wrap mood text in span for consistent font #}
                                   <span>{% trans "Mood" %}: {{ entry.mood }}</span> {# Added trans tag #}
                              </p>
                         {% endif %}
                         {% if entry.location %}
                              <p class="mb-1">
                                   <i class="fas fa-map-marker-alt mr-1"></i>
                                   {# Wrap location text in span for consistent font #}
                                   <span>{% trans "Location" %}: {{ entry.location }}</span> {# Added trans tag #}
                              </p>
                         {% endif %}
                          {% if entry.is_favorite %}
                              <p class="text-yellow-500 mt-2"><i class="fas fa-star mr-1"></i> <span>{% trans "Favorite" %}</span></p> {# Added trans tag #}
                          {% endif %}
                    </div>

                    {# Actions: Edit and Delete #}
                    <div class="mt-4 flex space-x-4">
                        <a href="{% url 'journal:journal_update' pk=entry.pk %}" class="px-4 py-2 bg-secondary-light text-white rounded-md hover:bg-secondary-dark transition duration-300 font-semibold text-sm shadow-md">
                            {% trans "Edit" %} {# Added trans tag #}
                        </a>
                        {# Delete button - Use a button for JS handling #}
                        {# Store entry ID and title in data attributes #}
                        <button
                            class="delete-entry-button px-4 py-2 bg-button-red text-white rounded-md hover:bg-red-700 transition duration-300 font-semibold text-sm shadow-md"
                            data-entry-id="{{ entry.pk }}" {# Store only the ID #}
                            data-entry-title="{{ entry.title|default:'Untitled Entry' }}" {# Store title for modal #}
                        >
                            {% trans "Delete" %} {# Added trans tag #}
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>

        {# TODO: Add Pagination controls here #}

    {% else %}
        {# Message if no journal entries are found #}
        {# Check if filters/search are applied #}
        {% if current_mood != 'all' or current_time_period != 'all' or current_is_favorite or current_search_query %}
             <div id="no-entries-message" class="text-center text-text-light dark:text-text-dark">
                 <p class="text-xl mb-4">{% trans "No journal entries match your current filters or search query." %}</p> {# Added trans tag #}
                 <a href="{% url 'journal:journal_list' %}" class="inline-block px-6 py-3 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-300 font-semibold shadow-md">
                     {% trans "Clear Filters" %} {# Added trans tag #}
                 </a>
             </div>
        {% else %}
            <div id="no-entries-message" class="text-center text-text-light dark:text-text-dark">
                <p class="text-xl mb-4">{% trans "You haven't written any journal entries yet." %}</p> {# Added trans tag #}
                <a href="{% url 'journal:journal_create' %}" class="inline-block px-6 py-3 bg-primary-light text-white rounded-md hover:bg-primary-dark transition duration-300 font-semibold shadow-md">
                    {% trans "Start Your First Entry" %} {# Added trans tag #}
                </a>
            </div>
        {% endif %}
    {% endif %}

    {# Custom Delete Confirmation Modal - Keep this here for now, but ideally move to base.html #}
    {# This HTML structure is needed for the shared ajax_delete.js script #}
    <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-card-light dark:bg-card-dark">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-800">
                    <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 text-2xl"></i> {# Warning icon #}
                </div>
                <h3 class="text-lg leading-6 font-medium text-text-light dark:text-text-dark mt-4">{% trans "Confirm Deletion" %}</h3> {# Added trans tag #}
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        {% trans "Are you sure you want to delete the journal entry titled" %}: "<strong id="modal-entry-title" class="text-primary-light dark:text-primary-dark"></strong>"? {# Added trans tag #}
                        {% trans "This action cannot be undone." %} {# Added trans tag #}
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    {# Data attributes will be set by the delete button click handler #}
                    <button id="confirm-delete-button"
                            class="px-4 py-2 bg-button-red text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-300 ease-in-out"
                            data-entry-id="" {# Placeholder #}
                            data-entry-element-id="" {# Placeholder #}
                        >
                        {% trans "Yes, Delete" %} {# Added trans tag #}
                    </button>
                    <button id="cancel-delete-button" class="mt-3 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 transition duration-300 ease-in-out">
                        {% trans "Cancel" %} {# Added trans tag #}
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{# Link to the shared Ajax Delete JavaScript file #}
{% block extra_js %}
{# Ensure you have created static/js/ajax_delete.js with the shared JS code #}
<script src="{% static 'js/ajax_delete.js' %}"></script>
{% endblock %}
