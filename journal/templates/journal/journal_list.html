{% extends 'base.html' %}

{% block title %}My Journal{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-4xl font-bold text-text-light dark:text-text-dark mb-8">My Journal Entries</h1>

    {# Link to create a new journal entry #}
    <div class="mb-6 text-right">
        <a href="{% url 'journal:journal_create' %}" class="inline-block px-6 py-3 bg-primary-light text-white rounded-md hover:bg-primary-dark transition duration-300 font-semibold shadow-md">
            + Write New Entry
        </a>
    </div>

    {# Check if there are any journal entries #}
    {% if journal_entries %}
        <div id="journal-entries-list" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            {# Loop through each journal entry #}
            {% for entry in journal_entries %}
                {# Add a data attribute to easily identify the entry element #}
                <div id="entry-{{ entry.pk }}" class="bg-card-light dark:bg-card-dark p-6 rounded-xl shadow-custom-light dark:shadow-custom-dark flex flex-col">
                    {# Link to the detail view of the entry #}
                    <a href="{% url 'journal:journal_detail' pk=entry.pk %}" class="block hover:underline">
                        <h2 class="text-2xl font-semibold text-primary-light dark:text-primary-dark mb-2 truncate">{{ entry.title|default:"Untitled Entry" }}</h2>
                    </a>
                    {# Display a snippet of the content #}
                    <p class="text-text-light dark:text-text-dark text-sm mb-4 flex-grow">{{ entry.content|truncatechars:200 }}</p>

                    {# Metadata: Date, Mood, Location (if available) #}
                    <div class="text-sm text-gray-600 dark:text-gray-400 mt-auto">
                        <p class="mb-1">
                            <i class="far fa-calendar-alt mr-1"></i>
                            {{ entry.created_at|date:"F j, Y" }} at {{ entry.created_at|date:"P" }}
                        </p>
                        {% if entry.mood %}
                            <p class="mb-1">
                                <i class="far fa-smile mr-1"></i>
                                Mood: {{ entry.mood }}
                            </p>
                        {% endif %}
                        {% if entry.location %}
                            <p class="mb-1">
                                <i class="fas fa-map-marker-alt mr-1"></i>
                                Location: {{ entry.location }}
                            </p>
                        {% endif %}
                        {# Placeholder for AI Quote/Favorite status - Will be styled later #}
                        {% if entry.ai_quote %}
                             <p class="italic mt-2 text-gray-700 dark:text-gray-300">"{{ entry.ai_quote|truncatechars:100 }}"</p>
                        {% endif %}
                         {% if entry.is_favorite %}
                             <p class="text-yellow-500 mt-2"><i class="fas fa-star mr-1"></i> Favorite</p>
                         {% endif %}
                    </div>

                    {# Actions: Edit and Delete #}
                    <div class="mt-4 flex space-x-4">
                        <a href="{% url 'journal:journal_update' pk=entry.pk %}" class="px-4 py-2 bg-secondary-light text-white rounded-md hover:bg-secondary-dark transition duration-300 font-semibold text-sm shadow-md">
                            Edit
                        </a>
                        {# Delete button - Use a button for JS handling #}
                        {# Add data attributes to store URL and entry ID #}
                        <button
                            class="delete-entry-button px-4 py-2 bg-button-red text-white rounded-md hover:bg-red-700 transition duration-300 font-semibold text-sm shadow-md"
                            data-delete-url="{% url 'journal:journal_delete' pk=entry.pk %}"
                            data-entry-id="{{ entry.pk }}"
                        >
                            Delete
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        {# Message if no journal entries are found #}
        <div id="no-entries-message" class="text-center text-text-light dark:text-text-dark">
            <p class="text-xl mb-4">You haven't written any journal entries yet.</p>
            <a href="{% url 'journal:journal_create' %}" class="inline-block px-6 py-3 bg-primary-light text-white rounded-md hover:bg-primary-dark transition duration-300 font-semibold shadow-md">
                Start Your First Entry
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}

{# Add JavaScript for handling Ajax delete #}
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find all delete buttons
        const deleteButtons = document.querySelectorAll('.delete-entry-button');
        const journalEntriesList = document.getElementById('journal-entries-list');
        const noEntriesMessage = document.getElementById('no-entries-message');

        // Function to get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Add click event listener to each delete button
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const deleteUrl = this.dataset.deleteUrl;
                const entryId = this.dataset.entryId;
                const entryElement = document.getElementById(`entry-${entryId}`);

                // Show a confirmation dialog (will replace with custom UI later)
                if (confirm('Are you sure you want to delete this journal entry?')) {
                    fetch(deleteUrl, {
                        method: 'POST', // Send as POST request
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest', // Identify as Ajax request
                            'X-CSRFToken': csrftoken, // Include CSRF token
                            // 'Content-Type': 'application/json' // Not strictly needed for simple delete POST
                        },
                    })
                    .then(response => {
                        // Log response details for debugging
                        console.log('Fetch response status:', response.status);
                        console.log('Fetch response status text:', response.statusText);
                        // Check if the response is successful (status code 2xx)
                        if (response.ok) {
                             // Try to parse JSON, but handle cases where it might not be JSON
                            return response.text().then(text => {
                                try {
                                    return JSON.parse(text);
                                } catch (e) {
                                    console.error('Failed to parse JSON response:', e);
                                    console.error('Response text:', text);
                                    throw new Error('Invalid JSON response from server.');
                                }
                            });
                        } else {
                             // If response is not ok, read the response body and throw an error
                            return response.text().then(text => {
                                console.error('Server returned non-OK status:', response.status, response.statusText);
                                console.error('Server response body:', text);
                                throw new Error(`Server error: ${response.status} ${response.statusText}`);
                            });
                        }
                    })
                    .then(data => {
                        // Handle the JSON response from the server
                        if (data.success) {
                            // Deletion was successful, remove the entry element from the DOM
                            if (entryElement) {
                                entryElement.remove();
                                console.log(`Journal entry ${data.entry_id} deleted successfully.`);

                                // Check if the list is now empty and show "no entries" message
                                if (journalEntriesList && journalEntriesList.children.length === 0) {
                                     if (noEntriesMessage) {
                                         noEntriesMessage.classList.remove('hidden');
                                     }
                                }
                            }
                        } else {
                            // Deletion failed based on server-side logic (e.g., not authorized, not found)
                            console.error('Deletion failed:', data.message || 'Server reported failure');
                            alert('Failed to delete journal entry: ' + (data.message || 'Unknown server error')); // Show a more specific alert
                        }
                    })
                    .catch(error => {
                        // Handle any network errors or errors thrown in the .then block
                        console.error('Error during deletion:', error);
                        alert('An error occurred while trying to delete the journal entry. Check console for details.'); // Direct user to console
                    });
                }
            });
        });

        // Optional: Add logic to initially hide the "no entries" message if there are entries
        // Check if the list element exists and has children
        if (journalEntriesList && journalEntriesList.children.length > 0) {
             if (noEntriesMessage) {
                 noEntriesMessage.classList.add('hidden');
             }
        } else {
             // Ensure message is visible if list is empty initially
             if (noEntriesMessage) {
                 noEntriesMessage.classList.remove('hidden');
             }
        }

    });
</script>
{% endblock %}
