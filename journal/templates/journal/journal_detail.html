{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load journal_tags %}

{% block title %}{{ entry.title|default:_("Untitled Entry") }} - {% trans "Journal" %}{% endblock %}

{% block extra_head %}
<style>
    :root {
        --primary-light: #4f46e5;
        --primary-dark: #818cf8;
        --secondary-light: #10b981;
        --secondary-dark: #34d399;
        --card-light: #ffffff;
        --card-dark: #1f2937;
        --text-light: #1f2937;
        --text-dark: #f3f4f6;
        --border-light: #e5e7eb;
        --border-dark: #374151;
    }

    /* Tag Pills */
    .tag-pill-detail {
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        color: #374151;
        border: none;
        transition: all 0.3s ease;
    }
    .dark .tag-pill-detail {
        background: linear-gradient(135deg, #4b5563, #6b7280);
        color: #d1d5db;
    }
    .tag-pill-detail:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Attachment Cards */
    .attachment-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 2rem;
    }
    .attachment-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 1rem;
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.4s ease-in-out;
        display: flex;
        flex-direction: column;
    }
    .dark .attachment-card {
        background: rgba(31, 41, 55, 0.9);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    .attachment-card:hover {
        transform: translateY(-5px) rotateX(2deg);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }
    .dark .attachment-card:hover {
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
    }

    .attachment-thumbnail-link {
        display: block;
        position: relative;
        width: 100%;
        padding-top: 66.66%;
        background: #e5e7eb;
        border-bottom: 1px solid #d1d5db;
        overflow: hidden;
    }
    .dark .attachment-thumbnail-link {
        background: #4b5563;
        border-bottom-color: #374151;
    }
    .attachment-thumbnail-link img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s ease-in-out;
    }
    .attachment-thumbnail-link:hover img {
        transform: scale(1.1);
    }
    .attachment-thumbnail-link .overlay-icon {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
    }
    .attachment-thumbnail-link:hover .overlay-icon {
        opacity: 1;
    }
    .attachment-thumbnail-link .overlay-icon i {
        font-size: 2.5rem;
        color: #ffffff;
    }

    .attachment-content {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 140px;
    }
    .attachment-icon-lg {
        font-size: 3.5rem;
        margin-bottom: 1rem;
    }

    .attachment-info {
        padding: 1rem 1.5rem 1.5rem;
        margin-top: auto;
    }
    .attachment-filename {
        font-weight: 600;
        color: #1f2937;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 0.5rem;
    }
    .dark .attachment-filename {
        color: #f3f4f6;
    }
    .attachment-meta {
        font-size: 0.875rem;
        color: #6b7280;
    }
    .dark .attachment-meta {
        color: #9ca3af;
    }
    .attachment-download-link {
        display: inline-flex;
        align-items: center;
        font-size: 0.875rem;
        color: var(--primary-light);
        transition: all 0.3s ease;
    }
    .dark .attachment-download-link {
        color: var(--primary-dark);
    }
    .attachment-download-link:hover {
        text-decoration: underline;
        color: #4338ca;
    }
    .dark .attachment-download-link:hover {
        color: #6366f1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-12">
    <article id="entry-{{ entry.pk }}" class="w-full max-w-5xl mx-auto bg-card-light dark:bg-card-dark p-8 rounded-3xl shadow-2xl dark:shadow-custom-dark">
        <header class="mb-10 pb-8 border-b border-border-light dark:border-border-dark">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-primary-light dark:text-primary-dark mb-4 leading-tight tracking-tight">
                {{ entry.title|default:_("Untitled Entry") }}
            </h1>
            <div class="text-base text-gray-500 dark:text-gray-400 flex flex-wrap items-center gap-x-6 gap-y-3">
                <span class="flex items-center">
                    <i class="far fa-calendar-alt mr-2 opacity-75"></i>
                    {{ entry.created_at|date:"F j, Y" }} {% trans "at" %} {{ entry.created_at|date:"P" }}
                </span>
                {% if entry.mood %}
                <span class="flex items-center">
                    {% with current_mood_visual=mood_visuals|get_item:entry.mood %}
                        {% if current_mood_visual.emoji %}<span class="mr-2 text-lg">{{ current_mood_visual.emoji }}</span>{% endif %}
                        <span class="{{ current_mood_visual.text_color|default:'' }}">{{ entry.get_mood_display }}</span>
                    {% endwith %}
                </span>
                {% endif %}
                {% if entry.location %}
                <span class="flex items-center truncate" title="{{ entry.location }}">
                    <i class="fas fa-map-marker-alt mr-2 opacity-75"></i>
                    <span class="truncate">{{ entry.location|truncatechars:30 }}</span>
                </span>
                {% endif %}
                {% if entry.is_favorite %}
                <span class="flex items-center text-yellow-500 dark:text-yellow-400 font-semibold">
                    <i class="fas fa-star mr-2"></i>{% trans "Favorite" %}
                </span>
                {% endif %}
            </div>
            {% if entry.tags.all %}
                <div class="mt-6 flex flex-wrap items-center gap-x-3 gap-y-2">
                    <span class="text-base text-gray-600 dark:text-gray-400 font-semibold mr-3">{% trans "Tags" %}:</span>
                    {% for tag in entry.tags.all %}
                        <a href="{% url 'journal:journal_list' %}?tag_filter={{ tag.name|urlencode }}" class="tag-pill-detail hover:opacity-80">
                            {{ tag }}
                        </a>
                    {% endfor %}
                </div>
            {% endif %}
            {% if entry.created_at|timesince:entry.updated_at != "0Â minutes" and entry.updated_at|date:"U" > entry.created_at|date:"U"|add:"60" %}
                <p class="text-sm text-gray-400 dark:text-gray-500 mt-3">
                    <em>({% blocktrans with time_diff=entry.updated_at|timesince:entry.created_at %}Last updated {{ time_diff }} ago{% endblocktrans %})</em>
                </p>
            {% endif %}
        </header>

        {% if entry.ai_quote %}
            <blockquote class="mb-10 p-6 bg-gray-100 dark:bg-gray-800 border-l-4 border-primary-light dark:border-primary-dark rounded-r-xl italic">
                <p class="text-text-light dark:text-text-dark text-lg leading-relaxed">"{{ entry.ai_quote }}"</p>
                <footer class="text-sm text-gray-500 dark:text-gray-400 mt-3">- {% trans "AI Reflection" %}</footer>
            </blockquote>
        {% endif %}

        <div class="prose dark:prose-invert max-w-none text-text-light dark:text-text-dark leading-relaxed text-xl">
            {{ entry.content|linebreaksbr }}
        </div>

        {% if entry.attachments.all %}
            <section class="mt-12 pt-8 border-t border-border-light dark:border-border-dark">
                <h3 class="text-3xl font-semibold text-text-light dark:text-text-dark mb-8">{% trans "Attachments" %}</h3>
                <div class="attachment-grid">
                    {% for attachment in entry.attachments.all %}
                        <div class="attachment-card">
                            {% with file_name=attachment.get_file_name %}
                                {% if attachment.file_type == 'image' %}
                                    <a href="{{ attachment.file.url }}" data-fancybox="gallery" data-caption="{{ file_name }}" class="attachment-thumbnail-link group">
                                        <img src="{{ attachment.file.url }}" alt="{{ file_name }}" 
                                             onerror="this.onerror=null; this.src='https://placehold.co/300x225/E2E8F0/4A5568?text=Image+Not+Found'; this.classList.add('object-contain');">
                                        <div class="overlay-icon">
                                            <i class="fas fa-search-plus"></i>
                                        </div>
                                    </a>
                                    <div class="attachment-info">
                                        <p class="attachment-filename" title="{{ file_name }}">{{ file_name }}</p>
                                    </div>
                                {% else %}
                                    <div class="attachment-content">
                                        {% if attachment.file_type == 'audio' %}
                                            <i class="fas fa-file-audio attachment-icon-lg text-blue-500 dark:text-blue-400"></i>
                                        {% elif attachment.file_type == 'video' %}
                                            <i class="fas fa-file-video attachment-icon-lg text-purple-500 dark:text-purple-400"></i>
                                        {% else %}
                                            <i class="fas fa-paperclip attachment-icon-lg text-gray-500 dark:text-gray-400"></i>
                                        {% endif %}
                                        <p class="attachment-filename mt-2" title="{{ file_name }}">{{ file_name }}</p>
                                    </div>
                                    {% if attachment.file_type == 'audio' %}
                                        <audio controls class="w-full px-4 pb-3">
                                            <source src="{{ attachment.file.url }}">
                                            {% trans "Your browser does not support the audio element." %}
                                        </audio>
                                    {% elif attachment.file_type == 'video' %}
                                        <video controls class="w-full rounded-b-xl max-h-60 bg-black">
                                            <source src="{{ attachment.file.url }}">
                                            {% trans "Your browser does not support the video tag." %}
                                        </video>
                                    {% endif %}
                                    <div class="attachment-info"></div>
                                {% endif %}
                                
                                <div class="px-4 pb-4 pt-3 flex justify-between items-center border-t border-gray-200 dark:border-gray-600">
                                    <a href="{{ attachment.file.url }}"
                                       class="attachment-download-link"
                                       download="{{ file_name }}">
                                        <i class="fas fa-download mr-2"></i> {% trans "Download" %}
                                    </a>
                                    <p class="attachment-meta">
                                        {{ attachment.get_file_type_display|capfirst }}
                                    </p>
                                </div>
                            {% endwith %}
                        </div>
                    {% endfor %}
                </div>
            </section>
        {% endif %}

        <footer class="mt-12 pt-8 border-t border-border-light dark:border-border-dark flex flex-col sm:flex-row justify-between items-center gap-6">
            <a href="{% url 'journal:journal_list' %}"
               class="inline-flex items-center px-6 py-3 bg-gray-200 dark:bg-gray-800 text-text-light dark:text-text-dark rounded-xl text-base font-semibold hover:bg-gray-300 dark:hover:bg-gray-700 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg">
                <i class="fas fa-arrow-left mr-2"></i>{% trans "Back to List" %}
            </a>
            <div class="flex space-x-4">
                <a href="{% url 'journal:journal_update' pk=entry.pk %}"
                   class="inline-flex items-center px-8 py-3 bg-gradient-to-r from-secondary-light to-secondary-dark text-white rounded-xl text-base font-semibold focus:outline-none focus:ring-2 focus:ring-secondary-dark dark:focus:ring-offset-gray-900 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg">
                    <i class="fas fa-edit mr-2"></i>{% trans "Edit Entry" %}
                </a>
                <button class="delete-entry-button inline-flex items-center px-8 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-xl text-base font-semibold focus:outline-none focus:ring-2 focus:ring-red-700 dark:focus:ring-offset-gray-900 transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg"
                        data-entry-id="{{ entry.pk }}"
                        data-entry-title="{{ entry.title|default:_('Untitled Entry') }}">
                    <i class="fas fa-trash-alt mr-2"></i>{% trans "Delete Entry" %}
                </button>
            </div>
        </footer>
    </article>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/ajax_delete.js' %}"></script>
{% endblock %}